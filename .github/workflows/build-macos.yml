name: Build macOS Application

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ["3.10"]
        include:
          - target: x86_64
            suffix: x86_64
          - target: arm64
            suffix: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build application
      run: |
        # 为不同架构设置构建参数
        if [ "${{ matrix.target }}" = "x86_64" ]; then
          ARCH_FLAG=""
          BUILD_NAME="CloudflareScan_x86_64"
        else
          ARCH_FLAG="--target-architecture arm64"
          BUILD_NAME="CloudflareScan_arm64"
        fi
        
        # 使用PyInstaller构建
        python -m PyInstaller --onefile --windowed \
          --name $BUILD_NAME \
          --icon=cfs.icns \
          --add-data "cfs.icns:." \
          $ARCH_FLAG \
          cfs-mac.py
        
        # 检查文件大小
        echo "Build completed for ${{ matrix.target }}"
        du -h "dist/$BUILD_NAME.app"
    
    - name: Create DMG package (可选)
      run: |
        # 安装create-dmg工具
        brew install create-dmg
        
        # 创建DMG文件
        BUILD_NAME="CloudflareScan_${{ matrix.suffix }}"
        APP_PATH="dist/$BUILD_NAME.app"
        DMG_NAME="CloudflareScan_${{ matrix.suffix }}.dmg"
        
        create-dmg \
          --volname "CloudflareScan" \
          --volicon "cfs.icns" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "$BUILD_NAME.app" 200 190 \
          --hide-extension "$BUILD_NAME.app" \
          --app-drop-link 600 185 \
          "$DMG_NAME" \
          "dist/"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareScan-${{ matrix.suffix }}
        path: |
          dist/CloudflareScan_${{ matrix.suffix }}.app
          CloudflareScan_${{ matrix.suffix }}.dmg
        retention-days: 7
